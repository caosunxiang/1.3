<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>新建作品</title>
		<link rel="stylesheet" href="layui/css/layui.css">
		<link rel="stylesheet" href="static/css/style.css">
		<style>
			.color {
				color: red;
			}
			
			.aa {
				margin-left: 5px;
			}
		</style>
	</head>

	<body>
		<div class="container">
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>新建作品</legend>
			</fieldset>

			<form class="layui-form">
				<div class="layui-form-item">
					<label class="layui-form-label">作品名称</label>
					<div class="layui-input-block">
						<input type="text" name="book_name" autocomplete="off" placeholder="请输入作品名称" class="layui-input book_name">
					</div>
				</div>
				<div class="layui-form-item  xuanze">
					<div class="layui-inline" style="width: 1400px;">
						<label class="layui-form-label">作品类型</label>
						<div class="layui-input-inline " style="width: 150px;">
							<select name="modules" lay-verify="required" lay-search="" id="xiala1" lay-filter="test1">
								<option value="">先选择一级板块</option>

							</select>
						</div>
						<div class="layui-input-inline " style="width: 150px;">
							<select name="modules" lay-verify="required" lay-search="" id="xiala2" lay-filter="test2">
								<option value="">再选择二级板块</option>

							</select>
						</div>
						<div class="layui-input-inline bankuai" style=" margin-top: 5px; margin-left: 10px;width: 800px;">
							<!--<li class="layui-btn layui-btn-primary layui-btn-sm aa">小型按钮
								<i class="layui-icon layui-icon-close-fill color"></i>
							</li>-->

						</div>
					</div>

				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">作品种类</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="type" name="book_type" value="end" title="完结" checked="">
						<input type="radio" lay-filter="type" name="book_type" value="serialization" title="连载">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">收费情况</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="status" name="vip_status" value="free" title="免费" checked="">
						<input type="radio" lay-filter="status" name="vip_status" value="vip" title="仅vip可读">
						<input type="radio" lay-filter="status" name="vip_status" value="price" title="购买阅读">
					</div>
				</div>
				<div class="layui-form-item pricediv" style="display: none;">
					<label class="layui-form-label">作品价格</label>
					<div class="layui-input-block">
						<input type="text" name="price" autocomplete="off" placeholder="作品是需要购买才能阅读的情况请填写价格" class="layui-input price" style="width: 500px;">

					</div>

				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">作品首发</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="first" name="first_start" value="Y" title="是" checked="">
						<input type="radio" lay-filter="first" name="first_start" value="N" title="否">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">责编</label>
					<div class="layui-input-block">
						<input type="text" name="edited" autocomplete="off" placeholder="请输入责编（选填）" class="layui-input edited" style="width: 500px;">

					</div>

				</div>
				<div class="layui-form-item layui-form-text ">
					<label class="layui-form-label ">作品描述</label>
					<div class="layui-input-block ">
						<textarea placeholder="请输入作品描述 " name="book_desc" class="layui-textarea book_desc"></textarea>
					</div>
				</div>
				<div class="layui-form-item layui-form-text ">
					<label class="layui-form-label ">作品公告</label>
					<div class="layui-input-block ">
						<textarea placeholder="请输入作品公告 " name="book_notice" class="layui-textarea book_notice"></textarea>
					</div>
				</div>
			</form>
			<div class="layui-upload">
				<button type="button" class="layui-btn" id="test1" style="margin-left: 110px;">上传图片</button>
				<div class="layui-upload-list" style="margin-left: 110px;">
					<img class="layui-upload-img" id="demo1" style="width: 200px;height: 300px;">
					<p id="demoText"></p>
				</div>
			</div>
			<div style="margin-left: 500px; ">
				<button class="layui-btn layui-btn-lg layui-btn-normal" id="save">保存草稿</button>
			</div>
		</div>
		<script type="text/javascript " src="js/jquery.min.js "></script>
		<script src="js/common.js "></script>
		<script src="layui/layui.js "></script>
		<script src="layer-v3.1.1/layer/mobile/layer.js"></script>
		<script type="text/html" id="barDemo1">
			<div class="layui-input-inline anniu add" style="margin-top: 5px;">
				<div class="layui-btn-group">
					<button class="layui-btn layui-btn-sm layui-btn-primary addbutton"><i class="layui-icon"></i></button>
				</div>
			</div>

		</script>
		<script type="text/html" id="barDemo2">
			<div class="layui-input-inline anniu del" style="margin-top: 5px;">
				<div class="layui-btn-group ">
					<button class="layui-btn layui-btn-sm layui-btn-primary"><i class="layui-icon"></i></button>
				</div>
			</div>

		</script>
		<script>
			var book_name = "";
			var book_type = "end";
			var first_start = "Y";
			var book_desc = "";
			var book_notice = "";
			var vip_status = "free";
			var edited = "";
			var price = "";
			var data = "";
			var uploadInst;
			var form;
			var upload;
			var plate_lowList = "";
			$(function() {
				layui.use(['element', 'form', "upload"],
					function() {
						var $ = layui.jquery,
							element = layui.element;
						form = layui.form;
						upload = layui.upload;

						$.ajax({
							type: "POST", //提交方式 
							url: baseurl + "/plate/getPlateList", //路径 

							//数据，这里使用的是Json格式进行传输 
							success: function(data) { //返回数据根据结果进行相应的处理 
								list = data.data;
								$.each(data.data, function(index, item) {
									$('#xiala1').append(new Option(item.plate_name, item.plate_id)); // 下拉菜单里添加元素
								})
								form.render(); //下拉菜单渲染 把内容加载进去
							}

						});
						form.on('radio(type)', function(data) {
							console.log(data.value); //被点击的radio的value值
							book_type = data.value;
						});
						form.on('radio(status)', function(data) {
							console.log(data.value); //被点击的radio的value值
							vip_status = data.value;
							if(vip_status == "price") {
								$(".pricediv").css("display", "");
							} else {
								$(".pricediv").css("display", "none");
							}
						});
						form.on('radio(first)', function(data) {
							console.log(data.value); //被点击的radio的value值
							first_start = data.value;
						});

						form.on('select(test1)', function(data) {
							console.log(data.elem); //得到select原始DOM对象
							console.log(data.value); //得到被选中的值
							console.log(data.othis); //得到美化后的DOM对象
							$('#xiala2').html("<option value=''>再选择二级板块</option>")
							getallplate(data.value);
						});
						form.on('select(test2)', function(data) {
							console.log(data.othis.name);
							console.log(data.elem); //得到select原始DOM对象
							console.log(data.value); //得到被选中的值
							console.log(data.othis); //得到美化后的DOM对象
							$.ajax({
								url: baseurl + '/plate_low/getPlate_lowInfo',
								dataType: 'json',
								type: 'post',
								data: {
									plate_low_id: data.value,
								},
								success: function(data) {
									if(data.meta.code == 200) {
										var plate_low_name = data.data.plate_low_name;
										$('.bankuai').append("<li  class='layui-btn layui-btn-primary layui-btn-sm aa' id='" + data.data.plate_low_id + "'>" + plate_low_name + " <i class = 'layui-icon layui-icon-close-fill color'> </i> </li>")

									}
								}
							});
						})

						//普通图片上传
						uploadInst = upload.render({
							elem: '#test1',
							auto: false,
							bindAction: "#save",
							url: baseurl + "/book/addBook",
							data: {
								book_name: book_name,
								price: price,
								edited: edited,
								book_desc: book_desc,
								book_notice: book_notice,
								book_type: book_type,
								first_start: first_start,
								vip_status: vip_status,
								user_id: localStorage.getItem("userId"),
								plate_lowList: plate_lowList,
							},
							before: function(obj) {
								$("li").each(function() {
									plate_lowList = $(this).attr("id") + "," + plate_lowList;
								})
								console.log(plate_lowList)
								if($(".book_name").val() == "" || $(".book_desc").val() == "" || $(".book_notice").val() == "") {
									return layer.msg('请填写完整信息');
								}

								this.data = {
									book_name: $(".book_name").val(),
									price: $(".price").val(),
									edited: $(".edited").val(),
									book_desc: $(".book_desc").val(),
									book_notice: $(".book_notice").val(),
									book_type: book_type,
									first_start: first_start,
									vip_status: vip_status,
									user_id: localStorage.getItem("userId"),
									plate_lowList: plate_lowList,
								}
								console.log(this.data);
							},
							choose: function(obj) {
								//预读本地文件示例，不支持ie8
								obj.preview(function(index, file, result) {
									$('#demo1').attr('src', result); //图片链接（base64）
								});
							},
							done: function(res) {

								//如果上传失败
								if(res.code > 0) {
									return layer.msg('上传失败');
								}
								console.log(res);
								//上传成功
								if(res.meta.code == 200) {
									return layer.msg('上传成功');
								} else if(res.meta.code == 333) {
									return layer.msg('作品类型不能为空');
								} else {
									return layer.msg('上传失败');
								}
							},
							error: function() {
								//演示失败状态，并实现重传
								var demoText = $('#demoText');
								demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
								demoText.find('.demo-reload').on('click', function() {
									uploadInst.upload();
								});
							}
						});
					});

				$('.bankuai').on('click', 'i', function() {
					$(this).parent("li").remove();
				});
			})

			function getallplate(plate_id) {
				layui.use('form',
					function() {
						form = layui.form;
						$.ajax({
							type: "POST", //提交方式 
							url: baseurl + "/plate_low/getallplate", //路径 
							data: {
								plate_id: plate_id,
							},
							//数据，这里使用的是Json格式进行传输 
							success: function(data) { //返回数据根据结果进行相应的处理 
								$.each(data.data, function(index, item) {
									if(item.type == 'plate') {
										$('#xiala2').append(new Option(item.plate_low_name + "(板块)", item.plate_low_id)); // 下拉菜单里添加元素
									} else {
										$('#xiala2').append(new Option(item.plate_low_name + "(标签)", item.plate_low_id)); // 下拉菜单里添加元素
									}

								})
								form.render(); //下拉菜单渲染 把内容加载进去

							}
						});
					})
			}
		</script>
	</body>

</html>