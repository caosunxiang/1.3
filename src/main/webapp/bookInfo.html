<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>详细信息</title>
		<link rel="stylesheet" href="layui/css/layui.css">
		<link rel="stylesheet" href="static/css/style.css">
		<style>
			.color {
				color: red;
			}
			
			.aa {
				margin-left: 5px;
			}
		</style>
	</head>

	<body>
		<div class="container">
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>详细信息</legend>
			</fieldset>
			<form class="layui-form" action="" enctype="multipart/form-data">
				<div class="layui-form-item">
					<label class="layui-form-label">作品名称</label>
					<div class="layui-input-block">
						<input type="text" name="title" lay-verify="required|title" autocomplete="off" placeholder="请输入作品名称" class="layui-input book_name">
					</div>
				</div>
				<div class="layui-form-item  xuanze">
					<div class="layui-inline" style="width: 1400px;">
						<label class="layui-form-label">作品类型</label>
						<div class="layui-input-inline " style="width: 150px;">
							<select name="modules" lay-verify="required" lay-search="" id="xiala1" lay-filter="test1">
								<option value="">先选择一级板块</option>

							</select>
						</div>
						<div class="layui-input-inline " style="width: 150px;">
							<select name="modules" lay-verify="required" lay-search="" id="xiala2" lay-filter="test2">
								<option value="">再选择二级板块</option>

							</select>
						</div>
						<div class="layui-input-inline bankuai" style=" margin-top: 5px; margin-left: 10px;width: 800px;">
							<!--<li class="layui-btn layui-btn-primary layui-btn-sm aa">小型按钮
								<i class="layui-icon layui-icon-close-fill color"></i>
							</li>-->

						</div>
					</div>

				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">作品种类</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="type" name="type" value="end" title="完结">
						<input type="radio" lay-filter="type" name="type" value="serialization" title="连载">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">收费情况</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="status" name="status" class="free" value="free" title="免费">
						<input type="radio" lay-filter="status" name="status" class="vip" value="vip" title="仅vip可读">
						<input type="radio" lay-filter="status" name="status" class="pricer" value="price" title="购买阅读">
					</div>
				</div>
				<div class="layui-form-item pricediv" style="display: none;">
					<label class="layui-form-label">作品价格</label>
					<div class="layui-input-block">
						<input type="text" name="title" lay-verify="number" autocomplete="off" placeholder="作品是需要购买才能阅读的情况请填写价格" class="layui-input price" style="width: 500px;">

					</div>

				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">作品首发</label>
					<div class="layui-input-block">
						<input type="radio" lay-filter="first" name="first" value="Y" title="是">
						<input type="radio" lay-filter="first" name="first" value="N" title="否">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">责编</label>
					<div class="layui-input-block">
						<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入责编（选填）" class="layui-input edited" style="width: 500px;">

					</div>

				</div>
				<div class="layui-form-item layui-form-text ">
					<label class="layui-form-label ">作品描述</label>
					<div class="layui-input-block ">
						<textarea placeholder="请输入作品描述 " class="layui-textarea book_desc"></textarea>
					</div>
				</div>
				<div class="layui-form-item layui-form-text ">
					<label class="layui-form-label ">作品公告</label>
					<div class="layui-input-block ">
						<textarea placeholder="请输入作品公告 " class="layui-textarea book_notice"></textarea>
					</div>
				</div>

			</form>
			<div class="layui-upload">
				<button type="button" class="layui-btn" id="test1" style="margin-left: 110px;">上传图片</button>
				<div class="layui-upload-list" style="margin-left: 110px;">
					<img class="layui-upload-img" id="demo1" style="width: 200px;height: 300px;">
					<p id="demoText"></p>
				</div>
			</div>
		</div>
		<div style="width: 216px; margin: 0px auto;">
			<!-- layui 2.2.5 新增 -->
			<button class="layui-btn layui-btn-fluid" id="save">修改保存</button>
		</div>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script src="js/common.js"></script>
		<script src="layui/layui.js"></script>
		<script src="layer-v3.1.1/layer/mobile/layer.js"></script>
		<script>
			var form;
			var book_id;
			var book_name;
			var book_type;
			var first_start;
			var book_desc;
			var book_notice;
			var vip_status;
			var edited;
			var price;
			var data;
			var upload;
			var layer;
			var plate_lowList = "";
			$(function() {
				book_id = getQueryString("book_id");
				layui.use(['element', 'form', 'upload', 'layer'], function() {
					var $ = layui.jquery,
						element = layui.element;
					form = layui.form;
					upload = layui.upload;
					layer = layui.layer;
					$.ajax({
						type: "POST", //提交方式 
						url: baseurl + "/plate/getPlateList", //路径 

						//数据，这里使用的是Json格式进行传输 
						success: function(data) { //返回数据根据结果进行相应的处理 
							list = data.data;
							$.each(data.data, function(index, item) {
								$('#xiala1').append(new Option(item.plate_name, item.plate_id)); // 下拉菜单里添加元素
							})
							form.render(); //下拉菜单渲染 把内容加载进去
						}

					});

					$.ajax({
						type: "POST", //提交方式 
						url: baseurl + "/book/getBookInfo", //路径 
						dataType: 'json',
						data: {
							book_id: book_id,
							user_id: localStorage.getItem("userId"),
							//book_id: book_id,
							//user_id: localStorage.getItem("userId"),
						}, //数据，这里使用的是Json格式进行传输 
						success: function(data) { //返回数据根据结果进行相应的处理 
							if(data.meta.code == 200) {
								var book = data.data;
								$(".book_name").val(book.book_name);
								book_type = book.book_type;
								if(book.book_type == "end") {
									$("input[value=end]").attr("checked", "");
									form.render();
								} else {
									$("input[value=serialization]").attr("checked", "");
									form.render();
								}
								vip_status = book.vip_status;
								if(book.vip_status == "free") {
									$(".free").attr("checked", "");
									form.render();
								} else if(book.vip_status == "vip") {
									$(".vip").attr("checked", "");
									form.render();
								} else {
									console.log(book.vip_status);
									$(".pricer").attr("checked", "");
									$(".pricediv").css("display", "");
									$(".price").val(book.price);
									form.render();

								}
								first_start = book.first_start;
								if(book.first_start == "Y") {
									$("input[value='Y']").attr("checked", "");
									form.render();
								} else {
									$("input[value='N']").attr("checked", "");
									form.render();
								}
								console.log(book.book_img);
								$("#demo1").attr("src", book.book_img);
								$(".edited").val(book.edited);
								$(".book_desc").val(book.book_desc);
								$(".book_notice").val(book.book_notice);
								if(book.plates.length > 0) {
									for(var i = 0; i < book.plates.length; i++) {
										$('.bankuai').append("<li  class='layui-btn layui-btn-primary layui-btn-sm aa' id='" + book.plates[i].plate_low_id + "'>" + book.plates[i].plate_low_name + " <i class = 'layui-icon layui-icon-close-fill color'> </i> </li>")

									}
								}

							} else {
								return layer.msg('获取信息失败');
							}
						}
					});

					form.on('radio(type)', function(data) {
						console.log(data.value); //被点击的radio的value值
						book_type = data.value;
					});
					form.on('radio(status)', function(data) {
						console.log(data.value); //被点击的radio的value值
						vip_status = data.value;

						if(vip_status == "price") {
							$(".pricediv").css("display", "");
						} else {
							$(".pricediv").css("display", "none");
						}
					});
					form.on('radio(first)', function(data) {
						console.log(data.value); //被点击的radio的value值
						first_start = data.value;
					});
					//普通图片上传
					uploadInst = upload.render({
						elem: '#test1',
						auto: false,
						bindAction: "#save",
						url: baseurl + "/book/updateBook",
						data: {
							book_id: book_id,
							book_name: book_name,
							price: price,
							edited: edited,
							book_desc: book_desc,
							book_notice: book_notice,
							book_type: book_type,
							first_start: first_start,
							vip_status: vip_status,
							user_id: localStorage.getItem("userId"),
							plate_lowList: plate_lowList,
						},
						before: function(obj) {
							$("li").each(function() {
								plate_lowList = $(this).attr("id") + "," + plate_lowList;
							})
							this.data = {
								book_id: book_id,
								book_name: $(".book_name").val(),
								price: $(".price").val(),
								edited: $(".edited").val(),
								book_desc: $(".book_desc").val(),
								book_notice: $(".book_notice").val(),
								book_type: book_type,
								first_start: first_start,
								vip_status: vip_status,
								plate_lowList: plate_lowList,

							}
							console.log(this.data);
							var thisFile = $(".layui-upload-file").val();
							if(thisFile == "") {
								uoloads(null);
							}

						},
						choose: function(obj) {
							//预读本地文件示例，不支持ie8
							obj.preview(function(index, file, result) {
								$('#demo1').attr('src', result); //图片链接（base64）
							});
						},
						done: function(res) {
							//如果上传失败
							if(res.code > 0) {
								return layer.msg('上传失败');
							}
							console.log(res);
							//上传成功
							if(res.meta.code == 200) {
								return layer.msg('上传成功');
								window.location.reload();
							}
						},
						error: function() {
							//演示失败状态，并实现重传
							var demoText = $('#demoText');
							demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
							demoText.find('.demo-reload').on('click', function() {
								uploadInst.upload();
							});
						}
					});

					form.on('select(test1)', function(data) {
						console.log(data.elem); //得到select原始DOM对象
						console.log(data.value); //得到被选中的值
						console.log(data.othis); //得到美化后的DOM对象
						$('#xiala2').html("<option value=''>再选择二级板块</option>")
						getallplate(data.value);
					});
					form.on('select(test2)', function(data) {
						console.log(data.othis.name);
						console.log(data.elem); //得到select原始DOM对象
						console.log(data.value); //得到被选中的值
						console.log(data.othis); //得到美化后的DOM对象
						$.ajax({
							url: baseurl + '/plate_low/getPlate_lowInfo',
							dataType: 'json',
							type: 'post',
							data: {
								plate_low_id: data.value,
							},
							success: function(data) {
								if(data.meta.code == 200) {
									var plate_low_name = data.data.plate_low_name;
									$('.bankuai').append("<li  class='layui-btn layui-btn-primary layui-btn-sm aa' id='" + data.data.plate_low_id + "'>" + plate_low_name + " <i class = 'layui-icon layui-icon-close-fill color'> </i> </li>")

								}
							}
						});
					})

				});
				$('.bankuai').on('click', 'i', function() {
					$(this).parent("li").remove();
				});

			})

			function uoloads(files) {
				$.ajax({
					type: "POST", //提交方式 
					url: baseurl + "/book/updateBook", //路径 
					dataType: 'json',
					data: {
						book_id: book_id,
						book_name: $(".book_name").val(),
						price: $(".price").val(),
						edited: $(".edited").val(),
						book_desc: $(".book_desc").val(),
						book_notice: $(".book_notice").val(),
						book_type: book_type,
						first_start: first_start,
						vip_status: vip_status,
						plate_lowList: plate_lowList,
						file: null
						//book_id: book_id,
						//user_id: localStorage.getItem("userId"),
					}, //数据，这里使用的是Json格式进行传输 
					success: function(data) { //返回数据根据结果进行相应的处理 
						if(data.meta.code == 200) {
							return layer.msg('上传成功');
						} else if(data.meta.code == 666) {
							return layer.msg('该书在审核中或者已审核通过，不能修改！', {
								icon: 5
							});

						} else {
							return layer.msg('上传失败');
						}
					}
				});
			}

			function getallplate(plate_id) {
				layui.use('form',
					function() {
						form = layui.form;
						$.ajax({
							type: "POST", //提交方式 
							url: baseurl + "/plate_low/getallplate", //路径 
							data: {
								plate_id: plate_id,
							},
							//数据，这里使用的是Json格式进行传输 
							success: function(data) { //返回数据根据结果进行相应的处理 
								$.each(data.data, function(index, item) {
									if(item.type == 'plate') {
										$('#xiala2').append(new Option(item.plate_low_name + "(板块)", item.plate_low_id)); // 下拉菜单里添加元素
									} else {
										$('#xiala2').append(new Option(item.plate_low_name + "(标签)", item.plate_low_id)); // 下拉菜单里添加元素
									}

								})
								form.render(); //下拉菜单渲染 把内容加载进去

							}
						});
					})
			}
		</script>
	</body>

</html>